<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traceback - Data Pipeline Incident Triage</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-search-plus text-3xl"></i>
                    <h1 class="text-2xl font-bold">Traceback</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90">Data Pipeline Incident Triage</span>
                    <div class="flex items-center space-x-2">
                        <div id="status-indicator" class="w-3 h-3 bg-green-400 rounded-full"></div>
                        <span id="status-text" class="text-sm">System Healthy</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- API Configuration -->
        <div class="mb-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-cog mr-2 text-blue-600"></i>
                API Configuration
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Base URL</label>
                    <input type="text" id="apiBaseUrl" value="http://localhost:8000" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-end">
                    <button onclick="testConnection()" 
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plug mr-2"></i>Test Connection
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button onclick="showTab('triage')" id="triage-tab" 
                            class="py-4 px-1 border-b-2 border-blue-500 font-medium text-blue-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Incident Triage
                    </button>
                    <button onclick="showTab('search')" id="search-tab" 
                            class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700">
                        <i class="fas fa-search mr-2"></i>Document Search
                    </button>
                    <button onclick="showTab('lineage')" id="lineage-tab" 
                            class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700">
                        <i class="fas fa-project-diagram mr-2"></i>Data Lineage
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Incident Triage Tab -->
                <div id="triage-content" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">Incident Triage Analysis</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Incident Description</label>
                                <textarea id="incidentQuestion" rows="4" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          placeholder="Describe the data pipeline incident or issue..."></textarea>
                                
                                <button onclick="triageIncident()" 
                                        class="mt-4 w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                                    <i class="fas fa-play mr-2"></i>Analyze Incident
                                </button>
                            </div>

                            <div>
                                <div id="triage-results" class="space-y-4">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                                        <p>Submit an incident description to get AI-powered analysis</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Search Tab -->
                <div id="search-content" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">Document Search</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search Query</label>
                                <input type="text" id="searchQuery" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Search for information about pipelines, tables, or processes...">
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Results Limit</label>
                                    <select id="searchLimit" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="3">3 results</option>
                                        <option value="5" selected>5 results</option>
                                        <option value="10">10 results</option>
                                    </select>
                                </div>

                                <button onclick="searchDocuments()" 
                                        class="mt-4 w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-search mr-2"></i>Search Documents
                                </button>

                                <div class="mt-6">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-book-open mr-2 text-blue-600"></i>Sources from Last Analysis
                                    </h4>
                                    <div id="recent-sources" class="flex flex-wrap gap-2 text-sm text-gray-700">
                                        <span class="text-gray-400 italic">Run an incident analysis to populate sources.</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div id="search-results" class="space-y-4">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-search text-4xl mb-4"></i>
                                        <p>Enter a search query to find relevant documents</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Lineage Tab -->
                <div id="lineage-content" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">Data Lineage Analysis</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Table Name</label>
                                <input type="text" id="tableName" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Enter table name (e.g., sales_orders, customer_data)">
                                
                                <button onclick="getLineage()" 
                                        class="mt-4 w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                                    <i class="fas fa-project-diagram mr-2"></i>Get Lineage
                                </button>

                                <div class="mt-6">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-network-wired mr-2 text-green-600"></i>Tables from Last Analysis
                                    </h4>
                                    <div id="recent-tables" class="flex flex-wrap gap-2 text-sm text-gray-700">
                                        <span class="text-gray-400 italic">Run an incident analysis to populate tables.</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div id="lineage-results" class="space-y-4">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-project-diagram text-4xl mb-4"></i>
                                        <p>Enter a table name to view its data lineage</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- System Stats Overview -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-gray-600"></i>
                System Overview
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-database text-blue-600 text-2xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Documents</p>
                            <p id="doc-count" class="text-xl font-semibold">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-sitemap text-green-600 text-2xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Lineage Nodes</p>
                            <p id="node-count" class="text-xl font-semibold">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-link text-purple-600 text-2xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Lineage Edges</p>
                            <p id="edge-count" class="text-xl font-semibold">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-code-branch text-orange-600 text-2xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">API Version</p>
                            <p id="api-version" class="text-xl font-semibold">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="loadSystemStats()" 
                        class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>Refresh Stats
                </button>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
            <div class="loading w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
            <span class="text-lg font-medium">Processing...</span>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'triage';
        let apiBaseUrl = 'http://localhost:8000';
        const DEFAULT_RETRIEVER = 'Lineage-Aware Retrieval';
        let lastSourcesUsed = [];
        let lastBlastRadius = [];
        let lastIncidentQuestion = '';
        let searchPrepopulated = false;
        let lineagePrepopulated = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            loadSystemStats();
        });

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active class to selected tab
            document.getElementById(tabName + '-tab').classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(tabName + '-tab').classList.add('border-blue-500', 'text-blue-600');
            
            currentTab = tabName;
            
            // Auto-populate document search with latest incident context
            if (tabName === 'search' && (lastIncidentQuestion || lastSourcesUsed.length > 0)) {
                const searchInput = document.getElementById('searchQuery');
                if (searchInput) {
                    const defaultQuery = lastSourcesUsed.length > 0 ? lastSourcesUsed[0] : lastIncidentQuestion;
                    searchInput.value = defaultQuery || '';
                }
                
                if (!searchPrepopulated) {
                    searchPrepopulated = true;
                    const defaultQuery = lastSourcesUsed.length > 0 ? lastSourcesUsed[0] : lastIncidentQuestion;
                    if (defaultQuery) {
                        searchDocuments(defaultQuery, null, true);
                    }
                }
            }
            
            // Auto-populate lineage tab with first blast radius table
            if (tabName === 'lineage' && lastBlastRadius.length > 0) {
                const lineageInput = document.getElementById('tableName');
                if (lineageInput) {
                    lineageInput.value = lastBlastRadius[0];
                }
                
                if (!lineagePrepopulated) {
                    lineagePrepopulated = true;
                    getLineage(lastBlastRadius[0], true);
                }
            }
        }

        // API functions
        async function testConnection() {
            const url = document.getElementById('apiBaseUrl').value;
            apiBaseUrl = url;
            
            try {
                const response = await fetch(`${apiBaseUrl}/health`);
                const data = await response.json();
                
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                if (data.status === 'healthy') {
                    statusIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                    statusText.textContent = 'System Healthy';
                } else {
                    statusIndicator.className = 'w-3 h-3 bg-yellow-400 rounded-full';
                    statusText.textContent = 'System Degraded';
                }
                
                // Connection test successful
            } catch (error) {
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                statusIndicator.className = 'w-3 h-3 bg-red-400 rounded-full';
                statusText.textContent = 'Connection Failed';
                
                console.warn('Connection test failed - check if API server is running');
            }
        }

        async function triageIncident() {
            const question = document.getElementById('incidentQuestion').value;
            const retrieverMethod = DEFAULT_RETRIEVER;
            
            if (!question.trim()) {
                alert('Please enter an incident description');
                return;
            }
            
            showLoading();
            
            try {
                lastIncidentQuestion = question;
                
                const response = await fetch(`${apiBaseUrl}/incident/triage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        retriever: retrieverMethod
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayTriageResults(data);
                } else {
                    throw new Error(data.detail || 'Triage failed');
                }
            } catch (error) {
                console.error('Triage error:', error.message);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayTriageResults(data) {
            const resultsDiv = document.getElementById('triage-results');
            
            // Ensure data has required fields
            if (!data) {
                resultsDiv.innerHTML = '<div class="text-center text-red-500 py-8"><p>Error: No data received</p></div>';
                return;
            }
            
            // Extract blast radius from incident brief if not provided separately
            let blastRadiusItems = Array.isArray(data.blast_radius) ? data.blast_radius.filter(item => item && item.trim().length > 0) : [];
            if (blastRadiusItems.length === 0 && data.incident_brief) {
                // Try to extract blast radius from the incident brief text
                const briefText = data.incident_brief;
                const blastRadiusMatch = briefText.match(/## 3\. Blast Radius([\s\S]*?)(?=## 4\.|$)/);
                if (blastRadiusMatch) {
                    const blastRadiusSection = blastRadiusMatch[1];
                    
                    // Extract table names and affected systems
                    const tableMatches = blastRadiusSection.match(/`([^`]+)`/g);
                    if (tableMatches) {
                        blastRadiusItems = tableMatches.map(match => match.replace(/`/g, '').trim());
                    }
                    
                    // Also extract bullet points if no tables found
                    if (blastRadiusItems.length === 0) {
                        const bulletPoints = blastRadiusSection.match(/[-•]\s*(.+)/g);
                        if (bulletPoints) {
                            blastRadiusItems = bulletPoints.map(point => point.replace(/^[-•]\s*/, '').trim());
                        }
                    }
                }
                
                // Fallback: look for narrative descriptions of downstream impact
                if (blastRadiusItems.length === 0) {
                    const downstreamMatch = briefText.match(/\*\*(?:Blast Radius|Impact on Downstream Systems)\*\*:\s*([\s\S]*?)(?:\n\s*\*\*|\n\n|$)/i);
                    if (downstreamMatch) {
                        const downstreamText = downstreamMatch[1];
                        
                        // Extract table names wrapped in backticks
                        const downstreamTables = downstreamText.match(/`([^`]+)`/g);
                        if (downstreamTables) {
                            blastRadiusItems = downstreamTables.map(item => item.replace(/`/g, '').trim());
                        } else {
                            // Split on commas, bullets, or newlines for plain text descriptions
                            blastRadiusItems = downstreamText
                                .split(/[,•\n]/)
                                .map(item => item.trim())
                                .filter(item => item.length > 0);
                        }
                    }
                }
                
                // Deduplicate while preserving order
                if (blastRadiusItems.length > 1) {
                    const seen = new Set();
                    blastRadiusItems = blastRadiusItems.filter(item => {
                        if (seen.has(item)) return false;
                        seen.add(item);
                        return true;
                    });
                }
                
                // Final fallback: capture table identifiers mentioned anywhere in the brief
                if (blastRadiusItems.length === 0) {
                    const tableMatches = briefText.match(/\b(?:raw|curated|analytics|bi|ops)\.[a-z0-9_]+/gi);
                    if (tableMatches) {
                        const seenTables = new Set();
                        blastRadiusItems = tableMatches
                            .map(table => table.toLowerCase())
                            .filter(table => {
                                if (seenTables.has(table)) return false;
                                seenTables.add(table);
                                return true;
                            })
                            .map(table => table);
                    }
                }
            }
            
            // Track latest sources and blast radius
            lastBlastRadius = Array.from(new Set(blastRadiusItems));
            if (Array.isArray(data.sources_used)) {
                const seenSources = new Set();
                lastSourcesUsed = data.sources_used
                    .map(item => (typeof item === 'string' ? item.trim() : ''))
                    .filter(item => {
                        if (!item || seenSources.has(item)) {
                            return false;
                        }
                        seenSources.add(item);
                        return true;
                    });
            } else {
                lastSourcesUsed = [];
            }
            updateDocumentSources(lastSourcesUsed);
            updateLineageSuggestions(lastBlastRadius);
            searchPrepopulated = false;
            lineagePrepopulated = false;
            
            resultsDiv.innerHTML = `
                <div class="fade-in space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 mb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Incident Brief
                        </h4>
                        ${blastRadiusItems.length > 0 ? `
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${blastRadiusItems.map(item => `
                                    <button type="button"
                                            class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-medium border border-yellow-200 hover:bg-yellow-200 transition-colors"
                                            onclick="openLineageForTable('${item.replace(/'/g, "\\'")}')">
                                        ${item}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${lastSourcesUsed.length > 0 ? `
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${lastSourcesUsed.map(source => `
                                    <button type="button"
                                            class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium border border-blue-200 hover:bg-blue-200 transition-colors"
                                            onclick="openSourceInSearch('${source.replace(/'/g, "\\'")}')">
                                        ${source}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="text-red-700 whitespace-pre-wrap">${formatIncidentBrief(data.incident_brief)}</div>
                    </div>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-medium">Processing Time:</span>
                                <span class="text-gray-600">${data.processing_time.toFixed(2)}s</span>
                            </div>
                            <div>
                                <span class="font-medium">Sources Used:</span>
                                <span class="text-gray-600">${data.sources_used ? data.sources_used.length : 0}</span>
                            </div>
                            <div>
                                <span class="font-medium">Analysis Time:</span>
                                <span class="text-gray-600">${new Date().toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateDocumentSources(sources) {
            const container = document.getElementById('recent-sources');
            if (!container) {
                return;
            }
            
            if (!sources || sources.length === 0) {
                container.innerHTML = '<span class="text-gray-400 italic">Run an incident analysis to populate sources.</span>';
                return;
            }
            
            container.innerHTML = sources.map(source => `
                <button type="button"
                        class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium border border-blue-200 hover:bg-blue-200 transition-colors"
                        onclick="openSourceInSearch('${source.replace(/'/g, "\\'")}')">
                    ${source}
                </button>
            `).join('');
        }
        
        async function openSourceInSearch(source) {
            if (!source) {
                return;
            }
            const searchInput = document.getElementById('searchQuery');
            if (searchInput) {
                searchInput.value = source;
            }
            showTab('search');
            await searchDocuments(source, null, true);
        }
        
        function updateLineageSuggestions(tables) {
            const container = document.getElementById('recent-tables');
            if (!container) {
                return;
            }
            
            if (!tables || tables.length === 0) {
                container.innerHTML = '<span class="text-gray-400 italic">Run an incident analysis to populate tables.</span>';
                return;
            }
            
            container.innerHTML = tables.map(table => `
                <button type="button"
                        class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-medium border border-green-200 hover:bg-green-200 transition-colors"
                        onclick="openLineageForTable('${table.replace(/'/g, "\\'")}')">
                    ${table}
                </button>
            `).join('');
        }
        
        async function openLineageForTable(table) {
            if (!table) {
                return;
            }
            const tableInput = document.getElementById('tableName');
            if (tableInput) {
                tableInput.value = table;
            }
            showTab('lineage');
            await getLineage(table, true);
        }

        function hideBlastRadiusSection(briefText) {
            if (!briefText) return '';
            
            // Remove the blast radius section from the incident brief
            // This prevents duplication since we extract and display it separately
            return briefText.replace(/## 3\. Blast Radius[\s\S]*?(?=## 4\.|$)/, '');
        }

        function formatIncidentBrief(briefText) {
            if (!briefText) return '';
            
            // Get current date and time
            const now = new Date();
            const currentDate = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const currentTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
            
            // Replace date placeholders with actual dates
            let formattedText = briefText
                .replace(/\[insert date\]/gi, currentDate)
                .replace(/\[insert time\]/gi, currentTime)
                .replace(/\[insert timestamp\]/gi, `${currentDate} at ${currentTime}`)
                .replace(/\[insert severity level\]/gi, 'Medium (P2)')
                .replace(/\[insert impact level\]/gi, 'Medium (P2)')
                .replace(/\[insert severity\]/gi, 'Medium (P2)');
            
            return formattedText;
        }

        function formatImpactAssessment(assessment) {
            if (!assessment) return 'No impact assessment available';
            
            let formatted = '';
            
            // If it's a string, display it as text
            if (typeof assessment === 'string') {
                formatted = `<div class="whitespace-pre-wrap text-sm">${assessment}</div>`;
            }
            // If it's an object, format it nicely
            else if (typeof assessment === 'object') {
                formatted = '<div class="space-y-2">';
                
                // Display assessment text if available
                if (assessment.assessment) {
                    formatted += `<div class="whitespace-pre-wrap text-sm">${assessment.assessment}</div>`;
                }
                
                // Display context sources if available
                if (assessment.context_sources && assessment.context_sources.length > 0) {
                    formatted += '<div class="mt-3"><h5 class="font-medium mb-2">Sources Used:</h5>';
                    formatted += '<ul class="text-xs space-y-1">';
                    assessment.context_sources.forEach(source => {
                        formatted += `<li class="bg-blue-50 p-2 rounded">${source.source || 'Unknown source'}</li>`;
                    });
                    formatted += '</ul></div>';
                }
                
                formatted += '</div>';
            }
            
            return formatted || '<div class="text-sm">Impact assessment data available</div>';
        }

        async function searchDocuments(queryOverride = null, limitOverride = null, silent = false) {
            const queryInput = document.getElementById('searchQuery');
            const limitSelect = document.getElementById('searchLimit');
            const query = queryOverride !== null ? queryOverride : (queryInput ? queryInput.value : '');
            const limit = limitOverride !== null ? limitOverride : (limitSelect ? limitSelect.value : 5);
            
            if (!query.trim()) {
                if (!silent) {
                    alert('Please enter a search query');
                }
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${apiBaseUrl}/incident/search?query=${encodeURIComponent(query)}&limit=${limit}`);
                const data = await response.json();
                
                if (response.ok) {
                    displaySearchResults(data);
                } else {
                    throw new Error(data.detail || 'Search failed');
                }
            } catch (error) {
                console.error('Search error:', error.message);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displaySearchResults(data) {
            const resultsDiv = document.getElementById('search-results');
            
            if (data.results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p>No results found for "${data.query}"</p>
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = `
                <div class="fade-in">
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-800">Search Results for "${data.query}"</h4>
                        <p class="text-sm text-gray-600">Found ${data.total} results</p>
                    </div>
                    <div class="space-y-4">
                        ${data.results.map((result, index) => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 card-hover">
                                <div class="flex items-start justify-between mb-2">
                                    <h5 class="font-medium text-gray-800">${result.source}</h5>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${result.type}</span>
                                </div>
                                <p class="text-gray-600 text-sm mb-3">${result.content.substring(0, 200)}${result.content.length > 200 ? '...' : ''}</p>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ${Object.keys(result.metadata).length} metadata fields
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function getLineage(tableNameOverride = null, silent = false) {
            const tableInput = document.getElementById('tableName');
            const tableName = tableNameOverride !== null
                ? tableNameOverride
                : (tableInput ? tableInput.value : '');
            
            if (tableInput && tableNameOverride !== null) {
                tableInput.value = tableNameOverride;
            }
            
            if (!tableName.trim()) {
                if (!silent) {
                    alert('Please enter a table name');
                }
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${apiBaseUrl}/lineage/${encodeURIComponent(tableName)}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayLineageResults(data);
                } else {
                    throw new Error(data.detail || 'Lineage query failed');
                }
            } catch (error) {
                console.error('Lineage error:', error.message);
                if (!silent) {
                    alert('Error: ' + error.message);
                }
            } finally {
                hideLoading();
            }
        }

        function displayLineageResults(data) {
            const resultsDiv = document.getElementById('lineage-results');
            
            resultsDiv.innerHTML = `
                <div class="fade-in space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-2">
                            <i class="fas fa-table mr-2"></i>Table: ${data.table}
                        </h4>
                        <p class="text-blue-700">Total Dependencies: ${data.total_dependencies}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h5 class="font-semibold text-green-800 mb-2">
                                <i class="fas fa-arrow-up mr-2"></i>Upstream Dependencies
                            </h5>
                            <ul class="text-green-700">
                                ${data.upstream_dependencies.length > 0 
                                    ? data.upstream_dependencies.map(dep => `<li class="mb-1">• ${dep}</li>`).join('')
                                    : '<li class="text-gray-500">No upstream dependencies</li>'
                                }
                            </ul>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h5 class="font-semibold text-red-800 mb-2">
                                <i class="fas fa-arrow-down mr-2"></i>Downstream Impact
                            </h5>
                            <ul class="text-red-700">
                                ${data.downstream_impact.length > 0 
                                    ? data.downstream_impact.map(impact => `<li class="mb-1">• ${impact}</li>`).join('')
                                    : '<li class="text-gray-500">No downstream impact</li>'
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadSystemStats() {
            try {
                const response = await fetch(`${apiBaseUrl}/system/stats`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('doc-count').textContent = data.vectorstore_documents;
                    document.getElementById('node-count').textContent = data.lineage_nodes;
                    document.getElementById('edge-count').textContent = data.lineage_edges;
                    document.getElementById('api-version').textContent = data.api_version;
                }
            } catch (error) {
                console.warn('Stats error:', error.message);
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Ensure loading overlay is hidden on page load
        document.addEventListener('DOMContentLoaded', function() {
            hideLoading();
        });

        // Auto-refresh system stats every 30 seconds
        setInterval(loadSystemStats, 30000);
    </script>
</body>
</html>

